{"version":3,"sources":["../src/app/main/main.ts"],"names":[],"mappings":"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","file":"main.js","sourcesContent":["import { config } from 'dotenv';\nimport { Locations, OBJECTNAME, Users } from '../services/firebase.service';\nimport { StoreDbService } from '../services/firebase.service'; // <== your updated store\nimport { UtilsService } from '../services/utils.service';\nimport { WebServerComponent } from '../components/webServer.component';\nimport { StripeService } from '../services/stripeAdn';\nimport { getAuth } from 'firebase-admin/auth';\n\nconfig(); // Load .env file\n\nexport class MainComponent {\n    private backendFbObjects = [\n        OBJECTNAME.wnUsers,\n        OBJECTNAME.wnLocations,\n        OBJECTNAME.wnBookings,\n    ];\n\n    private utilSvc = new UtilsService();\n    private storeDbSvc = new StoreDbService(this.utilSvc);\n    private stripeSvc = new StripeService();\n\n    private webServerComponent = new WebServerComponent(this.utilSvc, this.stripeSvc);\n\n    public version: string;\n\n    constructor() {\n        this.utilSvc.getParams();\n        this.initBackend();\n    }\n\n    public async initBackend(platform?: string, backendFbObjects = this.backendFbObjects): Promise<void> {\n        try {\n            const configData = await this.utilSvc.readConfig(\"/dist2/config/adf.json\", platform || this.utilSvc.platformEnv);\n            this.utilSvc.config = configData;\n\n            this.webServerComponent.initWebServer(); // Start Express server\n\n            this.storeDbSvc.initFirebase();\n\n            //            this.createUsers();\n            //            this.attachListingToUsers();\n\n            if (this.utilSvc.config.application?.release) {\n                this.version = this.utilSvc.config.application.release;\n            }\n        } catch (error) {\n            console.error('Error during backend initialization:', error);\n            throw error;\n        }\n    }\n\n\n    async cleanUpUsers() {\n        const listAllUsers = (nextPageToken) => {\n            let wnUser: Users;\n            // List batch of users, 1000 at a time.\n            this.utilSvc.firebaseAdmin\n                .auth()\n                .listUsers(1000, nextPageToken)\n                .then(async (listUsersResult) => {\n                    console.log('listUsersResult=', listUsersResult);\n                })\n                .catch((error) => {\n                    console.log('Error listing users:', error);\n                });\n        };\n    }\n\n    async listAuthUsers(nextPageToken?: string) {\n        const auth = getAuth();\n\n        try {\n            const listUsersResult = await auth.listUsers(1000, nextPageToken);\n\n            listUsersResult.users.forEach(userRecord => {\n                console.log('User:', userRecord.toJSON());\n            });\n\n            if (listUsersResult.pageToken) {\n                // If there are more users, recursively list them\n                await this.listAuthUsers(listUsersResult.pageToken);\n            }\n        } catch (error) {\n            console.error('Error listing Firebase Auth users:', error);\n        }\n    }\n\n    async createUsers() {\n        const temp = await this.storeDbSvc.getObject(OBJECTNAME.wnUsers);\n        const temptemp = this.utilSvc.objectToArray(temp) as Users[];\n\n\n        for (let u of temptemp) {\n            try {\n                console.log('b new userid=', u.userId, ', for email=', u.email);\n                let preuid = u.userId;\n                const userid = await this.storeDbSvc.getUserIdByEmail(u.email) as any;\n                u.userId = userid;\n                console.log('a new userid=', u.userId, ', for email=', u.email);\n                await this.storeDbSvc.setObject(OBJECTNAME.wnUsers + '/' + u.userId, u);\n                await this.storeDbSvc.removeObject(OBJECTNAME.wnUsers + '/' + preuid);\n            } catch (e) {\n                console.log('error e=', e)\n            }\n        }\n    }\n\n    async attachListingToUsers() {\n        const loc = await this.storeDbSvc.getObject(OBJECTNAME.wnLocations);\n        const locloc = this.utilSvc.objectToArray(loc) as Locations[];\n\n        const user = await this.storeDbSvc.getObject(OBJECTNAME.wnUsers);\n        const useruser = this.utilSvc.objectToArray(user) as Users[];\n\n\n        let i = 0;\n        for (let l of locloc) {\n            try {\n                l.owner = useruser[i].userId;\n                await this.storeDbSvc.setObject(OBJECTNAME.wnLocations + '/' + l.locationId, l);\n            } catch (e) {\n\n            }\n            i++;\n        }\n    }\n\n}\n"]}